{% extends 'base.html' %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">Ingreso</h5>
          <small class="text-muted">Autentícate para continuar</small>
        </div>
        <button id="jwt-btn" type="button" class="btn btn-outline-secondary btn-sm">Obtener JWT</button>
      </div>
      <div class="card-body">
        <div id="jwt-alert" class="alert d-none" role="alert"></div>
        <form method="post" class="mb-3" novalidate>
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Usuario</label>
            <input name="username" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" name="password" class="form-control" required>
          </div>
          <div class="d-flex justify-content-end">
            <button class="btn btn-primary" type="submit">Ingresar</button>
          </div>
        </form>
        <p class="text-muted small mb-0">El botón "Obtener JWT" usa tus mismas credenciales y guarda los tokens en localStorage. No reemplaza el login por sesión.</p>
      </div>
    </div>
  </div>
</div>
<script>
function showJwtAlert(type, message) {
  const alertBox = document.getElementById('jwt-alert');
  alertBox.className = `alert alert-${type}`;
  alertBox.textContent = message;
  alertBox.classList.remove('d-none');
}

document.getElementById('jwt-btn').addEventListener('click', async () => {
  const username = document.querySelector('input[name="username"]').value;
  const password = document.querySelector('input[name="password"]').value;
  if (!username || !password) {
    showJwtAlert('warning', 'Ingresa usuario y contraseña antes de solicitar el token.');
    return;
  }
  try {
    const res = await fetch('/api/token/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (res.ok) {
      localStorage.setItem('access', data.access);
      localStorage.setItem('refresh', data.refresh);
      showJwtAlert('success', 'Tokens guardados en localStorage. Puedes usarlos desde la opción "Tokens API (JWT)" una vez logueado.');
    } else {
      showJwtAlert('danger', data.detail || 'No se pudo obtener el token. Verifica tus credenciales.');
    }
  } catch (e) {
    showJwtAlert('danger', e.toString());
  }
});
</script>
{% endblock %}
